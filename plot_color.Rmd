---
title: "plot_color"
output: html_document
---

```{r setup, include=FALSE}
library(tigris)
library(dplyr)
library(leaflet)
library(sp)
library(ggmap)
library(maptools)
library(broom)
library(httr)
library(rgdal)
```

```{r}
r = GET('http://data.beta.nyc//dataset/3bf5fb73-edb5-4b05-bb29-7c95f4a727fc/resource/6df127b1-6d04-4bb7-b983-07402a2c3f90/download/f4129d9aa6dd4281bc98d0f701629b76nyczipcodetabulationareas.geojson')
nyc_zipcode = readOGR(content(r,'text'), 'OGRGeoJSON', verbose = F)

#summary(nyc_zipcode)

#nyc_zipcode_df <-= tidy(nyc_zipcode)

leaflet(nyc_zipcode) %>%
  addTiles() %>% 
  addPolygons(popup = ~postalCode)
```


## geo_jion

```{r}
data_hiv = read.csv("./data/combine_hiv_new.csv") %>%
  filter(gender == "All", age == "All", race == "All")

diagnoses_by_zipcode = data_hiv %>% 
  group_by(zipcode, uhf) %>% 
  summarise(sum_hiv_diagnoses = sum(hiv_diagnoses))

map_data = geo_join(nyc_zipcode, diagnoses_by_zipcode, "postalCode", "zipcode")
```

## point
```{r}
#nyc_zipcode_df = as_tibble(nyc_zipcode@data) 
#points_spdf = full_join(data_hiv, nyc_zipcode_df, by = "zipcode") %>% 

points_spdf = read.csv("./data/combine_hiv_pin.csv")

coordinates(points_spdf) = ~lng + lat
proj4string(points_spdf) = proj4string(nyc_zipcode)
matches = over(points_spdf, nyc_zipcode)

diagnoses_by_postalcode = diagnoses_by_zipcode %>% 
  rename(postalCode = zipcode)

points = full_join(matches, diagnoses_by_postalcode, by = "postalCode")
```



## color

```{r}
pal = colorNumeric(palette = "plasma", domain = range(map_data@data$sum_hiv_diagnoses, na.rm = T))
# "BuPu" "viridis" "Greens""inferno"

leaflet(map_data) %>%
  addTiles() %>%  
  addPolygons(color = "black", weight = 0.5, opacity = 1, 
              fillColor = ~pal(sum_hiv_diagnoses), 
              popup = ~stringr::str_c(uhf, "  sum:", factor(sum_hiv_diagnoses))) %>% 
  addMarkers(~longitude, ~latitude, 
             popup = ~stringr::str_c(uhf, "  sum:", factor(sum_hiv_diagnoses)), data = points) %>%  
  addProviderTiles("CartoDB.Positron") %>%
  setView(-73.98, 40.75, zoom = 11)

```

